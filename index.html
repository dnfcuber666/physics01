<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<title>2D 氣體分子運動模擬</title>
<style>
body { text-align: center; background: #f5f5f5; font-family: sans-serif; }
canvas { background: #fff; display: block; margin: 10px auto; border: 1px solid #ccc; }
.controls { margin: 10px; }
input, button { margin: 5px; }
.stats { margin: 10px; font-size: 18px; }
#colorBar { width: 600px; height: 20px; margin: 10px auto; border:1px solid #ccc; }
#histCanvas { width: 600px; height: 150px; margin: 10px auto; border:1px solid #ccc; }
</style>
</head>
<body>
<h1>2D 氣體分子運動模擬</h1>
<div class="controls">
  <label>初始溫度: <input type="range" id="tempInput" min="1000" max="50000" value="4000" step="100"></label>
  <span id="tempValue">4000</span>
  <label>粒子數量: <input type="range" id="numInput" min="50" max="500" value="200" step="1"></label>
  <span id="numValue">200</span>
  <button id="startBtn">開始</button>
  <button id="resetBtn">停止</button>
</div>
<div class="stats">
  平均速度: <span id="avgSpeed">0</span> |
  RMS速度: <span id="rmsSpeed">0</span> |
  壓力: <span id="pressure">0</span> |
  <span id="avgFrames">幀數: 0</span>
</div>
<canvas id="simCanvas" width="600" height="400"></canvas>
<canvas id="colorBar"></canvas>
<canvas id="histCanvas"></canvas>

<script>
const canvas = document.getElementById("simCanvas");
const ctx = canvas.getContext("2d");
const colorBar = document.getElementById("colorBar");
const colorCtx = colorBar.getContext("2d");
const histCanvas = document.getElementById("histCanvas");
const histCtx = histCanvas.getContext("2d");

let particles = [];
let numParticles = 200;
let radius = 3;
let initialTemp = 4000;
let running = false;

const framesForAverage = 500;
let impulseHistory = [];
let avgSpeedHistory = [];
let rmsSpeedHistory = [];

const tempInput = document.getElementById("tempInput");
const tempValue = document.getElementById("tempValue");
const numInput = document.getElementById("numInput");
const numValue = document.getElementById("numValue");

const avgSpeedEl = document.getElementById("avgSpeed");
const rmsSpeedEl = document.getElementById("rmsSpeed");
const pressureEl = document.getElementById("pressure");
const avgFramesEl = document.getElementById("avgFrames");

tempInput.addEventListener("input", () => tempValue.textContent = tempInput.value);
numInput.addEventListener("input", () => numValue.textContent = numInput.value);

function initParticles() {
  particles = [];
  let speed = Math.sqrt(initialTemp)/100; // 初始相同速度
  for (let i=0;i<numParticles;i++){
    let angle = Math.random()*2*Math.PI;
    particles.push({ x: Math.random()*(canvas.width-2*radius)+radius,
                     y: Math.random()*(canvas.height-2*radius)+radius,
                     vx: speed*Math.cos(angle),
                     vy: speed*Math.sin(angle),
                     radius: radius, mass:1 });
  }
  impulseHistory = [];
  avgSpeedHistory = [];
  rmsSpeedHistory = [];
}

// 顏色對應絕對速度，線性漸層
function getColorByAbsoluteSpeed(speed){
  if(speed<=0.2) return 'rgb(0,0,255)'; // 藍
  if(speed<=0.6){
    let t=(speed-0.2)/(0.6-0.2);
    let r=Math.floor(0*(1-t)+144*t);
    let g=Math.floor(0*(1-t)+238*t);
    let b=Math.floor(255*(1-t)+144*t);
    return `rgb(${r},${g},${b})`; // 淺綠
  }
  if(speed<=1.3){
    let t=(speed-0.6)/(1.3-0.6);
    let r=Math.floor(144*(1-t)+211*t);
    let g=Math.floor(238*(1-t)+211*t);
    let b=Math.floor(144*(1-t)+211*t);
    return `rgb(${r},${g},${b})`; // 灰
  }
  if(speed<=3){
    let t=(speed-1.3)/(3-1.3);
    let r=Math.floor(211*(1-t)+255*t);
    let g=Math.floor(211*(1-t)+0*t);
    let b=Math.floor(211*(1-t)+0*t);
    return `rgb(${r},${g},${b})`; // 紅
  }
  if(speed<=8){
    let t=(speed-3)/(8-3);
    let r=Math.floor(255*(1-t)+255*t);
    let g=Math.floor(0*(1-t)+165*t);
    let b=Math.floor(0*(1-t)+0*t);
    return `rgb(${r},${g},${b})`; // 橘黃色
  }
  return 'rgb(255,165,0)';
}

// 顏色條
function drawColorBar(){
  const grad=colorCtx.createLinearGradient(0,0,colorBar.width,0);
  grad.addColorStop(0,'#0000ff'); // 藍
  grad.addColorStop((0.6-0.2)/(8-0.2),'#90ee90'); // 淺綠
  grad.addColorStop((1.3-0.2)/(8-0.2),'#d3d3d3'); // 灰
  grad.addColorStop((3-0.2)/(8-0.2),'#ff0000'); // 紅
  grad.addColorStop(1,'#ffa500'); // 橘黃
  colorCtx.fillStyle=grad;
  colorCtx.fillRect(0,0,colorBar.width,colorBar.height);
  colorCtx.fillStyle='black';
  colorCtx.font='14px sans-serif';
  colorCtx.fillText('慢',0,15);
  colorCtx.fillText('中',colorBar.width/2-10,15);
  colorCtx.fillText('快',colorBar.width-25,15);
}

// 統計
function computeStats(){
  let totalSpeed=0,totalSpeedSq=0;
  for(let p of particles){
    let v=Math.sqrt(p.vx*p.vx+p.vy*p.vy);
    totalSpeed+=v;
    totalSpeedSq+=v*v;
  }
  let avgSpeed=totalSpeed/particles.length;
  let rmsSpeed=Math.sqrt(totalSpeedSq/particles.length);
  avgSpeedHistory.push(avgSpeed);
  rmsSpeedHistory.push(rmsSpeed);
  if(avgSpeedHistory.length>framesForAverage) avgSpeedHistory.shift();
  if(rmsSpeedHistory.length>framesForAverage) rmsSpeedHistory.shift();
  avgSpeedEl.textContent=(avgSpeedHistory.reduce((a,b)=>a+b,0)/avgSpeedHistory.length).toFixed(2);
  rmsSpeedEl.textContent=(rmsSpeedHistory.reduce((a,b)=>a+b,0)/rmsSpeedHistory.length).toFixed(2);
}

// 分子間碰撞
function handleCollisions(){
  for(let i=0;i<particles.length;i++){
    for(let j=i+1;j<particles.length;j++){
      let p1=particles[i], p2=particles[j];
      let dx=p2.x-p1.x, dy=p2.y-p1.y;
      let dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<p1.radius+p2.radius){
        let nx=dx/dist, ny=dy/dist;
        let p=2*(p1.vx*nx+p1.vy*ny - p2.vx*nx - p2.vy*ny)/(p1.mass+p2.mass);
        p1.vx-=p*p2.mass*nx; p1.vy-=p*p2.mass*ny;
        p2.vx+=p*p1.mass*nx; p2.vy+=p*p1.mass*ny;
        let overlap=p1.radius+p2.radius-dist;
        if(overlap>0){ p1.x-=nx*overlap/2; p1.y-=ny*overlap/2; p2.x+=nx*overlap/2; p2.y+=ny*overlap/2; }
      }
    }
  }
}

// 畫速度直方圖
function drawHistogram(){
  histCtx.clearRect(0,0,histCanvas.width,histCanvas.height);
  const bins=50;
  let speeds = particles.map(p=>Math.sqrt(p.vx*p.vx+p.vy*p.vy));
  let maxSpeed = 8;
  let hist = Array(bins).fill(0);
  speeds.forEach(s=>{
    let idx = Math.min(Math.floor(s/maxSpeed*bins), bins-1);
    hist[idx]++;
  });
  let maxCount = Math.max(...hist);
  for(let i=0;i<bins;i++){
    let h = hist[i]/maxCount*histCanvas.height;
    histCtx.fillStyle='gray';
    histCtx.fillRect(i*(histCanvas.width/bins),histCanvas.height-h,histCanvas.width/bins-1,h);
  }
}

function update(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  let frameImpulse=0;
  for(let p of particles){
    p.x+=p.vx; p.y+=p.vy;
    if(p.x-p.radius<0){ frameImpulse+=Math.abs(2*p.vx)*10000; p.vx*=-1; p.x=p.radius; }
    if(p.x+p.radius>canvas.width){ frameImpulse+=Math.abs(2*p.vx)*10000; p.vx*=-1; p.x=canvas.width-p.radius; }
    if(p.y-p.radius<0){ frameImpulse+=Math.abs(2*p.vy)*10000; p.vy*=-1; p.y=p.radius; }
    if(p.y+p.radius>canvas.height){ frameImpulse+=Math.abs(2*p.vy)*10000; p.vy*=-1; p.y=canvas.height-p.radius; }
    let v = Math.sqrt(p.vx*p.vx+p.vy*p.vy);
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.radius,0,2*Math.PI);
    ctx.fillStyle=getColorByAbsoluteSpeed(v);
    ctx.fill();
  }
  handleCollisions();
  impulseHistory.push(frameImpulse);
  if(impulseHistory.length>framesForAverage) impulseHistory.shift();
  let totalImpulse=impulseHistory.reduce((a,b)=>a+b,0);
  let containerLength=2*(canvas.width+canvas.height);
  let P=totalImpulse/containerLength/impulseHistory.length;
  pressureEl.textContent=P.toFixed(2);
  avgFramesEl.textContent=`幀數: ${impulseHistory.length}`;
  computeStats();
  drawHistogram();
  if(running) requestAnimationFrame(update);
}

document.getElementById("startBtn").onclick=()=>{
  if(!running){
    initialTemp=parseFloat(tempInput.value);
    numParticles=parseInt(numInput.value);
    tempInput.disabled=true;
    numInput.disabled=true;
    initParticles();
    drawColorBar();
    running=true;
    update();
  }
};

document.getElementById("resetBtn").onclick=()=>{
  running=false;
  tempInput.disabled=false;
  numInput.disabled=false;
  initParticles();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  histCtx.clearRect(0,0,histCanvas.width,histCanvas.height);
  avgSpeedEl.textContent="0";
  rmsSpeedEl.textContent="0";
  pressureEl.textContent="0";
  avgFramesEl.textContent="幀數: 0";
  drawColorBar();
};

initParticles();
drawColorBar();
</script>
</body>
</html>
