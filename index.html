<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>2D 氣體分子運動模擬</title>
  <style>
    body { text-align: center; background: #f5f5f5; font-family: sans-serif; }
    canvas { background: #fff; display: block; margin: 10px auto; border: 1px solid #ccc; }
    .controls { margin: 10px; }
    input, button { margin: 5px; }
    .stats { margin: 10px; font-size: 18px; }
  </style>
</head>
<body>
  <h1>2D 氣體分子運動模擬</h1>
  <div class="controls">
    <label>初始溫度: <input type="range" id="tempInput" min="1000" max="100000" value="4000" step="100"></label>
    <span id="tempValue">4000</span>
    <label>粒子數量: <input type="range" id="numInput" min="100" max="2000" value="500" step="1"></label>
    <span id="numValue">500</span>
    <button id="startBtn">開始</button>
    <button id="resetBtn">重設</button>
  </div>
  <div class="stats">
    平均速度: <span id="avgSpeed">0</span> |
    溫度: <span id="temperature">0</span> |
    壓力: <span id="pressure">0</span> |
    <span id="avgFrames">幀數: 0</span>
  </div>
  <canvas id="simCanvas" width="600" height="400"></canvas>

  <script>
    const canvas = document.getElementById("simCanvas");
    const ctx = canvas.getContext("2d");

    let particles = [];
    let numParticles = 500;
    let radius = 5;
    let initialTemp = 4000;
    let running = false;

    const framesForAverage = 10000; // 最近 10000 幀計算壓力
    let impulseHistory = [];

    const tempInput = document.getElementById("tempInput");
    const tempValue = document.getElementById("tempValue");
    const numInput = document.getElementById("numInput");
    const numValue = document.getElementById("numValue");

    const avgSpeedEl = document.getElementById("avgSpeed");
    const temperatureEl = document.getElementById("temperature");
    const pressureEl = document.getElementById("pressure");
    const avgFramesEl = document.getElementById("avgFrames");

    tempInput.addEventListener("input", () => tempValue.textContent = tempInput.value);
    numInput.addEventListener("input", () => numValue.textContent = numInput.value);

    function initParticles() {
      particles = [];
      let speedScale = Math.sqrt(initialTemp) / 100;
      for (let i = 0; i < numParticles; i++) {
        let angle = Math.random() * 2 * Math.PI;
        let speed = speedScale * (0.5 + Math.random());
        particles.push({
          x: Math.random() * (canvas.width - 2 * radius) + radius,
          y: Math.random() * (canvas.height - 2 * radius) + radius,
          vx: speed * Math.cos(angle),
          vy: speed * Math.sin(angle),
          radius: radius
        });
      }
      impulseHistory = [];
    }

    function computeStats() {
      let totalSpeed = 0;
      let totalSpeedSq = 0;
      for (let p of particles) {
        let v = Math.sqrt(p.vx*p.vx + p.vy*p.vy);
        totalSpeed += v;
        totalSpeedSq += v*v;
      }
      let avgSpeed = totalSpeed / particles.length;
      let temperature = totalSpeedSq / particles.length;
      avgSpeedEl.textContent = avgSpeed.toFixed(2);
      temperatureEl.textContent = temperature.toFixed(2);
    }

    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      let frameImpulse = 0;

      for (let p of particles) {
        p.x += p.vx;
        p.y += p.vy;

        if (p.x - p.radius < 0) { frameImpulse += Math.abs(2*p.vx) * 10000; p.vx *= -1; }
        if (p.x + p.radius > canvas.width) { frameImpulse += Math.abs(2*p.vx) * 10000; p.vx *= -1; }
        if (p.y - p.radius < 0) { frameImpulse += Math.abs(2*p.vy) * 10000; p.vy *= -1; }
        if (p.y + p.radius > canvas.height) { frameImpulse += Math.abs(2*p.vy) * 10000; p.vy *= -1; }

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, 2*Math.PI);
        ctx.fill();
      }

      impulseHistory.push(frameImpulse);
      if (impulseHistory.length > framesForAverage) impulseHistory.shift();

      let totalImpulse = impulseHistory.reduce((a,b) => a+b, 0);
      let containerLength = 2 * (canvas.width + canvas.height);
      let P = totalImpulse / containerLength / impulseHistory.length;
      pressureEl.textContent = P.toFixed(2);

      avgFramesEl.textContent = `幀數: ${impulseHistory.length}`;

      computeStats();
      if (running) requestAnimationFrame(update);
    }

    document.getElementById("startBtn").onclick = () => {
      if (!running) {
        initialTemp = parseFloat(tempInput.value);
        numParticles = parseInt(numInput.value);
        tempInput.disabled = true;
        numInput.disabled = true;
        initParticles();
        running = true;
        update();
      }
    };

    document.getElementById("resetBtn").onclick = () => {
      running = false;
      tempInput.disabled = false;
      numInput.disabled = false;
      initParticles();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      avgSpeedEl.textContent = "0";
      temperatureEl.textContent = "0";
      pressureEl.textContent = "0";
      avgFramesEl.textContent = "幀數: 0";
    };

    initParticles();
  </script>
</body>
</html>
